# Research: RAG Embeddings Pipeline

**Feature**: 001-rag-embeddings-pipeline
**Date**: 2025-12-26
**Phase**: 0 - Research

## 1. Cohere Embed v3 Models

### Decision: Use `embed-english-v3.0`

**Rationale**: Book content is English-only; full 1024 dimensions provide best semantic quality for documentation retrieval.

**Alternatives Considered**:
- `embed-multilingual-v3.0`: Same dimensions but unnecessary for English-only content
- `embed-english-light-v3.0` (384 dims): Faster/cheaper but lower quality for technical documentation where precision matters

### Key Specifications

| Aspect | Value |
|--------|-------|
| Vector Dimensions | 1,024 |
| Max Input Tokens | 512 |
| Max Sentences/Call | 96 (batch size) |
| Free Tier Limit | 1,000 API calls/month |

### Rate Limit Strategy
- Batch 96 embeddings per API call to maximize free tier
- 1,000 calls Ã— 96 = 96,000 max embeddings/month (sufficient for typical book)

---

## 2. Qdrant Cloud Free Tier

### Decision: Use Qdrant Cloud Free Tier with Cosine distance

**Rationale**: 1GB free tier sufficient for book-sized collections; Cosine distance optimal for normalized embeddings.

**Alternatives Considered**:
- Self-hosted Qdrant: More control but requires infrastructure management
- Pinecone/Weaviate: More expensive, no advantage for this use case

### Key Specifications

| Specification | Value |
|---------------|-------|
| Storage | 1GB forever (no credit card) |
| Distance Metric | Cosine (pre-normalizes for speed) |
| Estimated Capacity | ~175K vectors at 1024 dims |
| Payload Strategy | `payload_on_disk: true` for chunk text |

### Collection Configuration
```python
{
    "vectors": {
        "size": 1024,
        "distance": "Cosine"
    },
    "optimizers_config": {
        "payload_on_disk": True
    }
}
```

---

## 3. Python Crawling Stack

### Decision: httpx + BeautifulSoup4

**Rationale**: httpx provides modern async support for concurrent requests; BeautifulSoup4 is forgiving with HTML and has excellent Docusaurus compatibility.

**Alternatives Considered**:
- requests: Synchronous only, slower for bulk crawling
- lxml: Faster parsing but requires C compiler, overkill for Docusaurus static HTML
- Scrapy: Full framework, excessive complexity for simple sitemap-based crawling

### Docusaurus Crawling Strategy
1. Fetch `/sitemap.xml` (auto-generated by Docusaurus plugin)
2. Parse all `<loc>` URLs from sitemap
3. Fetch each page with httpx async client
4. Extract main content using BeautifulSoup selectors

### Content Extraction Selectors
- Main content: `article.markdown` or `div.theme-doc-markdown`
- Remove: `nav`, `footer`, `.theme-doc-sidebar`, `.theme-doc-toc`

---

## 4. Text Chunking Strategy

### Decision: RecursiveCharacterTextSplitter with 400-token chunks

**Rationale**: Cohere max is 512 tokens; 400 leaves buffer while maximizing context per chunk. Recursive splitter preserves paragraph/sentence boundaries.

**Alternatives Considered**:
- Fixed character splitting: Breaks mid-word/sentence, poor retrieval quality
- Semantic chunking: More complex, diminishing returns for structured documentation
- TokenTextSplitter: Can corrupt multi-byte characters

### Configuration

| Parameter | Value | Rationale |
|-----------|-------|-----------|
| chunk_size | 400 tokens | Leave 112 token buffer for Cohere 512 limit |
| chunk_overlap | 80 tokens (20%) | Preserve context across chunks |
| separators | `["\n\n", "\n", " ", ""]` | Prioritize paragraph/line breaks |

---

## 5. Project Setup with uv

### Decision: Use uv for package management

**Rationale**: 10-100x faster than pip, creates reproducible lockfiles, single tool replaces pip+virtualenv+pip-tools.

**Alternatives Considered**:
- pip + venv: Slower, no lockfile without pip-tools
- poetry: Slower dependency resolution, more complex
- conda: Overkill for pure-Python project

### Project Initialization
```bash
uv init backend
cd backend
uv add httpx beautifulsoup4 qdrant-client cohere python-dotenv
```

### Dependencies
| Package | Purpose |
|---------|---------|
| httpx | Async HTTP client for crawling |
| beautifulsoup4 | HTML parsing |
| qdrant-client | Qdrant Cloud API |
| cohere | Cohere embeddings API |
| python-dotenv | Environment variable management |

---

## Summary of Technical Decisions

| Component | Choice | Key Reason |
|-----------|--------|------------|
| Embedding Model | embed-english-v3.0 | 1024 dims, English-only content |
| Vector DB | Qdrant Cloud Free | 1GB free, Cosine distance |
| HTTP Client | httpx | Async, modern, fast |
| HTML Parser | BeautifulSoup4 | Forgiving, easy selectors |
| Text Splitter | RecursiveCharacterTextSplitter | Preserves structure, 400 tokens |
| Package Manager | uv | Fast, reproducible |

All NEEDS CLARIFICATION items resolved. Ready for Phase 1 design.
